##
# Add few rules which deny using cache
##
# Don't skip cache by default
set $skip_cache 0;

# POST requests and urls with a query string should always go to PHP
if ($request_method = POST) {
    set $skip_cache 1;
}

# If theres any args skip cache
if ($query_string != "") {
    set $skip_cache 1;
}

# Don't use the cache for logged in users or recent commenters
if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in|woocommerce_items_in_cart") {
    set $skip_cache 1;
}

# Use redis caching for index
# Cache wp_ prefix so that we can clear nginx full page cache with:
# $ wp cache flush
set $cache_key "wp_:nginx:$real_scheme$request_method$host$request_uri";
set_escape_uri $escaped_cache_key $cache_key;

srcache_fetch_skip $skip_cache;
srcache_store_skip $skip_cache;

srcache_response_cache_control on;

srcache_fetch GET /redis-fetch $cache_key;
srcache_store PUT /redis-store key=$escaped_cache_key;

# Add header which allows easier debugging
more_set_headers 'X-Cache $srcache_fetch_status';
