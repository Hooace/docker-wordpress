#!/usr/bin/with-contenv bash
##
# This startup script adds all docker container ENVs to php ENVs by adding them into php configs
##

php_config_file=/etc/php/php-fpm.d/env.conf

# Don't recreate the php-fpm file if it exists ( the container was restarted )
if [ ! -f $php_config_file ];
then
    # Init comments into file
    echo "; This file contains all ENV from docker" >> $php_config_file
    echo "" >> $php_config_file

    # Loop all docker envs without system envs
    # This has problems with multiline envs
    # But since we don't need the keys we are alright
    for env in $(env -u PATH -u PWD -u SHLVL -u TERM -u HOME -u HOSTNAME -u no_proxy -u _ -u EDITOR -u MANPATH); do

        env_key=""
        env_value=""
        # Extract key and value from 'KEY=VALUE' format
        env_key=$(echo $env | grep "=" | cut -f1 -d '=')
        env_value=$(echo $env | grep "=" | cut -f2 -d '=')


        # Skip empty ENVs or lines without '=' ( multiline envs don't behave really well with bash for loop )
        if [ "$env_key" == "" ] || [ "$env_value" == "" ]; then
            continue
        fi

        # Add all docker envs to php-fpm
        echo "env[\"${env_key}\"] = \"\$${env_key}\"" >> $php_config_file
    done

    # Empty line in the end for better readability
    echo "" >> $php_config_file
fi
